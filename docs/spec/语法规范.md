# AetherLang 语法规范

> 本文档定义 AetherLang 的语法规则，使用 BNF 表示法。

## 1. 程序结构

```bnf
<program> ::= <item>*

<item> ::= <function>
         | <struct>
         | <enum>
         | <impl>
         | <interface>
         | <const>
```

## 2. 函数定义

```bnf
<function> ::= "fn" <ident> "(" <params>? ")" ("->" <type>)? <block>

<params> ::= <param> ("," <param>)*
<param> ::= <ident> ":" <ownership>? <type>

<ownership> ::= "own" | "ref" | "mut"
```

示例：
```aether
fn add(a: i32, b: i32) -> i32 {
    return a + b
}

fn consume(data: own String) {
    // 获得所有权
}

fn read(data: ref String) {
    // 只读借用
}

fn modify(data: mut String) {
    // 可变借用
}
```

## 3. 类型定义

### 3.1 结构体

```bnf
<struct> ::= "struct" <ident> "{" <field>* "}"
<field> ::= <ident> ":" <type>
```

示例：
```aether
struct Point {
    x: i32
    y: i32
}
```

### 3.2 枚举

```bnf
<enum> ::= "enum" <ident> "{" <variant>* "}"
<variant> ::= <ident> ("(" <type> ("," <type>)* ")")?
```

示例：
```aether
enum Result<T, E> {
    Ok(T)
    Err(E)
}
```

### 3.3 接口

```bnf
<interface> ::= "interface" <ident> "{" <fn_sig>* "}"
<fn_sig> ::= "fn" <ident> "(" <params>? ")" ("->" <type>)?
```

示例：
```aether
interface Allocator {
    fn alloc(size: usize) -> *void
    fn free(ptr: *void)
}
```

### 3.4 实现块

```bnf
<impl> ::= "impl" (<ident> "for")? <ident> "{" <function>* "}"
```

示例：
```aether
impl Point {
    fn new(x: i32, y: i32) -> Point {
        return Point { x: x, y: y }
    }
}

impl Allocator for HeapAllocator {
    fn alloc(size: usize) -> *void {
        // 实现
    }
}
```

## 4. 语句

```bnf
<statement> ::= <let_stmt>
              | <expr_stmt>
              | <return_stmt>
              | <if_stmt>
              | <loop_stmt>
              | <match_stmt>

<let_stmt> ::= "let" "mut"? <ident> (":" <type>)? ("=" <expr>)?

<return_stmt> ::= "return" <expr>?

<block> ::= "{" <statement>* "}"
```

示例：
```aether
let x = 42
let mut y: i32 = 10
y = 20
return x + y
```

## 5. 表达式

```bnf
<expr> ::= <literal>
         | <ident>
         | <binary_expr>
         | <unary_expr>
         | <call_expr>
         | <field_expr>
         | <index_expr>
         | <block_expr>
         | <if_expr>
         | <match_expr>
         | <loop_expr>

<binary_expr> ::= <expr> <binop> <expr>
<unary_expr> ::= <unop> <expr>
<call_expr> ::= <expr> "(" <args>? ")"
<field_expr> ::= <expr> "." <ident>
<index_expr> ::= <expr> "[" <expr> "]"

<if_expr> ::= "if" <expr> <block> ("else" <block>)?
<match_expr> ::= "match" <expr> "{" <match_arm>* "}"
<match_arm> ::= <pattern> "=>" <expr> ","?

<loop_expr> ::= "loop" <block>
              | "while" <expr> <block>
              | "for" <ident> "in" <expr> <block>
```

## 6. 类型

```bnf
<type> ::= <ident>                           // 命名类型
         | "*" <type>                         // 指针
         | "&" "mut"? <type>                  // 引用
         | "[" <type> ";" <expr> "]"          // 数组
         | "[" <type> "]"                     // 切片
         | "(" <type> ("," <type>)* ")"       // 元组
         | "fn" "(" <type>* ")" "->" <type>   // 函数类型
         | "!"                                // Never 类型
         | "()"                               // Unit 类型
```

### 6.1 基本类型

| 类型 | 大小 | 描述 |
|------|------|------|
| `i8` | 1 | 8位有符号整数 |
| `i16` | 2 | 16位有符号整数 |
| `i32` | 4 | 32位有符号整数 |
| `i64` | 8 | 64位有符号整数 |
| `isize` | 8 | 指针大小有符号整数 |
| `u8` | 1 | 8位无符号整数 |
| `u16` | 2 | 16位无符号整数 |
| `u32` | 4 | 32位无符号整数 |
| `u64` | 8 | 64位无符号整数 |
| `usize` | 8 | 指针大小无符号整数 |
| `f32` | 4 | 32位浮点数 |
| `f64` | 8 | 64位浮点数 |
| `bool` | 1 | 布尔值 |
| `char` | 4 | Unicode 字符 |

## 7. 模式匹配

```bnf
<pattern> ::= "_"                             // 通配符
            | <ident>                         // 绑定
            | <literal>                       // 字面量
            | <ident> "{" <field_pat>* "}"    // 结构体
            | <ident> "(" <pattern>* ")"      // 枚举变体
            | "(" <pattern>* ")"              // 元组
```

示例：
```aether
match result {
    Ok(value) => {
        println("Success: {}", value)
    }
    Err(error) => {
        println("Error: {}", error)
    }
}
```

## 8. Unsafe 块

```bnf
<unsafe_block> ::= "unsafe" <block>
```

示例：
```aether
unsafe {
    let ptr = addr as *u32
    *ptr = 42
}
```

## 9. 内联汇编

```bnf
<asm_block> ::= "asm" "{" <asm_content> "}"
```

示例：
```aether
fn read_port(port: u16) -> u8 {
    unsafe {
        let value: u8
        asm {
            "in al, dx"
            in: port
            out: value
        }
        return value
    }
}
```

## 10. 实现参考

- AST 定义: [`src/frontend/ast.rs`](file:///c:/Users/Z1529/.gemini/antigravity/scratch/AetherLang/src/frontend/ast.rs)
- Parser 实现: [`src/frontend/parser.rs`](file:///c:/Users/Z1529/.gemini/antigravity/scratch/AetherLang/src/frontend/parser.rs)
