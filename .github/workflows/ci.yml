name: Cross-Platform Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # C backend - reliable, no external dependencies
  build-c-backend:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo
      uses: Swatinem/rust-cache@v2

    - name: Build (C backend)
      run: cargo build --release --no-default-features

    - name: Run unit tests
      run: cargo test --no-default-features

    - name: Test C backend compilation
      run: |
        ./target/release/aethc --emit-c tests/hello.aeth
        cat tests/hello.c
      shell: bash

    - name: End-to-end test (compile and run)
      if: runner.os != 'Windows'
      run: |
        ./target/release/aethc --emit-c tests/hello.aeth
        cc -o tests/hello tests/hello.c
        ./tests/hello
      shell: bash

  # LLVM backend - Linux only (easier LLVM setup)
  build-llvm-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Install LLVM 19
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 19
        sudo apt-get install -y llvm-19-dev libpolly-19-dev
        echo "LLVM_SYS_191_PREFIX=/usr/lib/llvm-19" >> $GITHUB_ENV

    - name: Cache cargo
      uses: Swatinem/rust-cache@v2

    - name: Build (LLVM backend)
      run: cargo build --release --features llvm

    - name: Run unit tests (LLVM)
      run: cargo test --features llvm

    - name: Test LLVM backend compilation
      run: |
        ./target/release/aethc build tests/hello.aeth -o tests/hello_llvm
        ./tests/hello_llvm || echo "Binary execution test"

  # Script layer tests
  test-script-layer:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo
      uses: Swatinem/rust-cache@v2

    - name: Run script module tests
      run: "cargo test script:: --no-default-features"

    - name: Test .ath transpilation
      run: |
        cargo build --release --no-default-features
        # Test that transpiler is functional (via unit tests)
        cargo test transpiler --no-default-features

  # Stdlib compilation check
  test-stdlib:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo
      uses: Swatinem/rust-cache@v2

    - name: Build compiler
      run: cargo build --release --no-default-features

    - name: Test stdlib modules compile
      run: |
        echo "Testing stdlib modules..."
        ./target/release/aethc --emit-c stdlib/result.aeth || echo "result.aeth needs work"
        ./target/release/aethc --emit-c stdlib/alloc.aeth || echo "alloc.aeth needs work"
        echo "Stdlib check complete"
